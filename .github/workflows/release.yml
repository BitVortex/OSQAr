name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  pypi-publish:
    name: Publish osqar to PyPI
    runs-on: ubuntu-latest
    environment: pypi
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Build distributions
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade build twine
          python -m build

      - name: Validate distributions
        run: python -m twine check dist/*

      - name: Publish to PyPI (Trusted Publishing)
        uses: pypa/gh-action-pypi-publish@release/v1

  framework-bundle:
    name: Framework bundle (docs + CLI + templates)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry

      - name: Configure Poetry
        run: |
          poetry config virtualenvs.create true
          poetry config virtualenvs.in-project true

      - name: Install dependencies
        run: poetry install

      - name: Build framework documentation (HTML)
        run: |
          poetry run sphinx-build -b html -W . _build/html

      - name: Assemble bundle directory (via osqar)
        run: |
          set -euo pipefail
          chmod +x ./osqar
          ./osqar framework bundle \
            --version "${GITHUB_REF_NAME}" \
            --docs-dir _build/html \
            --output-dir _dist

      - name: Generate checksum manifest (bundle directory)
        run: |
          set -euo pipefail
          bundle_dir="_dist/osqar-framework-${GITHUB_REF_NAME}"
          chmod +x ./osqar
          ./osqar checksum generate --root "${bundle_dir}" --output "${bundle_dir}/SHA256SUMS"
          ./osqar checksum verify --root "${bundle_dir}" --manifest "${bundle_dir}/SHA256SUMS"

      - name: Create bundle archive (zip)
        run: |
          set -euo pipefail
          export SOURCE_DATE_EPOCH="$(git log -1 --format=%ct)"
          chmod +x ./osqar

          bundle_dir="_dist/osqar-framework-${GITHUB_REF_NAME}"
          out="osqar_framework_bundle_${GITHUB_REF_NAME}.zip"
          rm -f "${out}" "${out}.sha256"

          ./osqar shipment package --shipment "${bundle_dir}" --output "${out}"
          sha256sum "${out}" > "${out}.sha256"

      - name: Upload framework bundle artifacts
        uses: actions/upload-artifact@v4
        with:
          name: osqar-framework-bundle
          path: |
            osqar_framework_bundle_${{ github.ref_name }}.zip
            osqar_framework_bundle_${{ github.ref_name }}.zip.sha256

  bazel-example-shipment:
    name: Example shipment (reproducible, Bazel) [${{ matrix.example }}]
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        example: [c_shared_lib, c_hello_world, cpp_hello_world, rust_hello_world]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install system build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            ca-certificates \
            build-essential \
            default-jre-headless \
            graphviz \
            plantuml

      - name: Set up Bazelisk
        uses: bazelbuild/setup-bazelisk@v3
        with:
          bazelisk-version: '1.20.0'

      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry

      - name: Configure Poetry
        run: |
          poetry config virtualenvs.create true
          poetry config virtualenvs.in-project true

      - name: Install dependencies
        run: poetry install --with evidence

      - name: Build reproducible Bazel shipment (${{ matrix.example }})
        run: |
          set -euo pipefail
          export SOURCE_DATE_EPOCH="$(git log -1 --format=%ct)"

          ex_dir="examples/${{ matrix.example }}"
          ship_root="_ci_shipments"
          ship_dir="${ship_root}/${{ matrix.example }}"
          out="osqar_${{ matrix.example }}_shipment.zip"

          rm -rf "${ship_root}"
          mkdir -p "${ship_dir}/implementation" "${ship_dir}/tests" "${ship_dir}/reports"

          echo "== Building ${ex_dir} (Bazel, reproducible)"
          pushd "${ex_dir}" >/dev/null
          chmod +x ./bazel-build-and-test.sh

          OSQAR_REPRODUCIBLE=1 ./bazel-build-and-test.sh

          rm -f coverage_report.txt coverage.xml
          case "${{ matrix.example }}" in
            c_shared_lib)
              rm -rf _coverage_build
              mkdir -p _coverage_build
              cc --coverage -O0 -g -Iinclude -c src/osqar_shared.c -o _coverage_build/osqar_shared.o
              cc --coverage -O0 -g -Iinclude -c tests/test_osqar_shared.c -o _coverage_build/test_osqar_shared.o
              cc --coverage -o _coverage_build/junit_tests _coverage_build/osqar_shared.o _coverage_build/test_osqar_shared.o
              ./_coverage_build/junit_tests test_results.xml
              poetry run gcovr -r . --object-directory _coverage_build --exclude 'tests/.*' --print-summary > coverage_report.txt 2>&1 || true
              poetry run gcovr -r . --object-directory _coverage_build --exclude 'tests/.*' --xml-pretty -o coverage.xml >/dev/null 2>&1 || true
              ;;
            c_hello_world)
              rm -rf _coverage_build
              mkdir -p _coverage_build
              cc --coverage -O0 -g -Iinclude -I../c_shared_lib/include -c ../c_shared_lib/src/osqar_shared.c -o _coverage_build/osqar_shared.o
              cc --coverage -O0 -g -Iinclude -I../c_shared_lib/include -c src/tsim.c -o _coverage_build/tsim.o
              cc --coverage -O0 -g -Iinclude -I../c_shared_lib/include -c tests/test_tsim.c -o _coverage_build/test_tsim.o
              cc --coverage -o _coverage_build/junit_tests _coverage_build/osqar_shared.o _coverage_build/tsim.o _coverage_build/test_tsim.o
              ./_coverage_build/junit_tests test_results.xml
              poetry run gcovr -r . --object-directory _coverage_build --exclude 'tests/.*' --print-summary > coverage_report.txt 2>&1 || true
              poetry run gcovr -r . --object-directory _coverage_build --exclude 'tests/.*' --xml-pretty -o coverage.xml >/dev/null 2>&1 || true
              ;;
            cpp_hello_world)
              rm -rf _coverage_build
              mkdir -p _coverage_build
              cc --coverage -O0 -g -I../c_shared_lib/include -c ../c_shared_lib/src/osqar_shared.c -o _coverage_build/osqar_shared.o
              c++ --coverage -O0 -g -Iinclude -I../c_shared_lib/include -c src/tsim.cpp -o _coverage_build/tsim.o
              c++ --coverage -O0 -g -Iinclude -I../c_shared_lib/include -c tests/test_tsim.cpp -o _coverage_build/test_tsim.o
              c++ --coverage -o _coverage_build/junit_tests _coverage_build/osqar_shared.o _coverage_build/tsim.o _coverage_build/test_tsim.o
              ./_coverage_build/junit_tests test_results.xml
              poetry run gcovr -r . --object-directory _coverage_build --exclude 'tests/.*' --print-summary > coverage_report.txt 2>&1 || true
              poetry run gcovr -r . --object-directory _coverage_build --exclude 'tests/.*' --xml-pretty -o coverage.xml >/dev/null 2>&1 || true
              ;;
            rust_hello_world)
              if ! command -v cargo >/dev/null 2>&1; then
                curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --profile minimal --default-toolchain stable
                source "$HOME/.cargo/env"
              else
                source "$HOME/.cargo/env" 2>/dev/null || true
              fi

              rustup component add llvm-tools-preview >/dev/null 2>&1 || true
              cargo install cargo-llvm-cov --locked >/dev/null 2>&1 || true

              cargo llvm-cov run --locked --release --bin junit_tests -- test_results.xml >/dev/null 2>&1 || true
              cargo llvm-cov report --locked --release --summary-only > coverage_report.txt 2>&1 || true
              cargo llvm-cov report --locked --release --cobertura --output-path coverage.xml >/dev/null 2>&1 || true
              ;;
          esac

          if [ ! -f coverage_report.txt ]; then
            echo "Coverage report not generated." > coverage_report.txt
          fi

          rm -rf _build/html
          poetry run sphinx-build -b html . _build/html

          cp -f test_results.xml _build/html/test_results.xml
          cp -f coverage_report.txt _build/html/coverage_report.txt
          if [ -f coverage.xml ]; then
            cp -f coverage.xml _build/html/coverage.xml
          fi
          popd >/dev/null

          cp -a "${ex_dir}/_build/html/." "${ship_dir}/"

          if [ -d "${ex_dir}/src" ]; then
            mkdir -p "${ship_dir}/implementation/src"
            cp -a "${ex_dir}/src/." "${ship_dir}/implementation/src/"
          fi
          if [ -d "${ex_dir}/include" ]; then
            mkdir -p "${ship_dir}/implementation/include"
            cp -a "${ex_dir}/include/." "${ship_dir}/implementation/include/"
          fi
          if [ -d "${ex_dir}/tests" ]; then
            mkdir -p "${ship_dir}/tests"
            cp -a "${ex_dir}/tests/." "${ship_dir}/tests/"
          fi

          for f in CMakeLists.txt Cargo.toml Cargo.lock BUILD.bazel MODULE.bazel .bazelrc build-and-test.sh bazel-build-and-test.sh; do
            if [ -f "${ex_dir}/${f}" ]; then
              cp -a "${ex_dir}/${f}" "${ship_dir}/implementation/"
            fi
          done

          for f in test_results.xml coverage_report.txt coverage.xml complexity_report.txt; do
            if [ -f "${ex_dir}/${f}" ]; then
              cp -a "${ex_dir}/${f}" "${ship_dir}/reports/"
            fi
          done

          # Supplier metadata (shipped)
          if [ -f "${ex_dir}/osqar_project.json" ]; then
            cp -a "${ex_dir}/osqar_project.json" "${ship_dir}/osqar_project.json"
          fi

          chmod +x ./osqar
          ./osqar traceability "${ship_dir}/needs.json" \
            --json-report "${ship_dir}/traceability_report.json"

          ./osqar checksum generate --root "${ship_dir}" --output "${ship_dir}/SHA256SUMS"
          ./osqar checksum verify --root "${ship_dir}" --manifest "${ship_dir}/SHA256SUMS"

          rm -f "${out}" "${out}.sha256"
          ./osqar shipment package --shipment "${ship_dir}" --output "${out}"
          sha256sum "${out}" > "${out}.sha256"

      - name: Upload shipment archive (${{ matrix.example }})
        uses: actions/upload-artifact@v4
        with:
          name: osqar-example-shipment-${{ matrix.example }}
          path: |
            osqar_${{ matrix.example }}_shipment.zip
            osqar_${{ matrix.example }}_shipment.zip.sha256

  example-workspace:
    name: Example workspace (combined, verifiable)
    runs-on: ubuntu-24.04
    needs: bazel-example-shipment
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry

      - name: Configure Poetry
        run: |
          poetry config virtualenvs.create true
          poetry config virtualenvs.in-project true

      - name: Install dependencies
        run: poetry install

      - name: Download per-example shipments
        uses: actions/download-artifact@v4
        with:
          pattern: osqar-example-shipment-*
          path: _ci_per_example
          merge-multiple: true

      - name: Create combined workspace (intake + package ZIP)
        run: |
          set -euo pipefail
          export SOURCE_DATE_EPOCH="$(git log -1 --format=%ct)"

          chmod +x ./osqar

          rm -rf _ci_shipments
          mkdir -p _ci_shipments

          # Extract each per-example shipment into a combined folder tree.
          for a in _ci_per_example/osqar_*_shipment.zip; do
            unzip -q "${a}" -d _ci_shipments
          done

          ws_root="_ci_workspace/osqar-example-workspace-${GITHUB_REF_NAME}"
          rm -rf "${ws_root}"
          mkdir -p _ci_workspace

          ./osqar workspace intake \
            --root _ci_shipments \
            --recursive \
            --output "${ws_root}" \
            --force \
            --traceability \
            --doctor \
            --enforce-deps

          out="osqar_example_workspace_${GITHUB_REF_NAME}.zip"
          rm -f "${out}" "${out}.sha256"
          ./osqar shipment package --shipment "${ws_root}" --output "${out}"
          sha256sum "${out}" > "${out}.sha256"

      - name: Upload example workspace artifacts
        uses: actions/upload-artifact@v4
        with:
          name: osqar-example-workspace
          path: |
            osqar_example_workspace_${{ github.ref_name }}.zip
            osqar_example_workspace_${{ github.ref_name }}.zip.sha256

  publish:
    name: Publish GitHub Release assets
    runs-on: ubuntu-latest
    needs:
      - framework-bundle
      - example-workspace
    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: List files to upload
        run: |
          set -euo pipefail
          ls -la dist

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            # Framework tooling first
            dist/osqar_framework_bundle_${{ github.ref_name }}.zip
            dist/osqar_framework_bundle_${{ github.ref_name }}.zip.sha256

            # Combined example workspace
            dist/osqar_example_workspace_${{ github.ref_name }}.zip
            dist/osqar_example_workspace_${{ github.ref_name }}.zip.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
