name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  framework-bundle:
    name: Framework bundle (docs + CLI + templates)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry

      - name: Configure Poetry
        run: |
          poetry config virtualenvs.create true
          poetry config virtualenvs.in-project true

      - name: Install dependencies
        run: poetry install

      - name: Build framework documentation (HTML)
        run: |
          poetry run sphinx-build -b html -W . _build/html

      - name: Assemble bundle directory
        run: |
          set -euo pipefail
          poetry run python ci/assemble_framework_bundle.py \
            --version "${GITHUB_REF_NAME}" \
            --docs-dir _build/html \
            --output-dir _dist

      - name: Generate checksum manifest (bundle directory)
        run: |
          set -euo pipefail
          bundle_dir="_dist/osqar-framework-${GITHUB_REF_NAME}"
          poetry run python tools/generate_checksums.py --root "${bundle_dir}" --output "${bundle_dir}/SHA256SUMS"
          poetry run python tools/generate_checksums.py --root "${bundle_dir}" --verify "${bundle_dir}/SHA256SUMS"

      - name: Create deterministic bundle archive (tar.gz)
        run: |
          set -euo pipefail
          export SOURCE_DATE_EPOCH="$(git log -1 --format=%ct)"

          out="osqar_framework_bundle_${GITHUB_REF_NAME}.tar.gz"
          rm -f "${out}" "${out}.sha256"

          tar -c \
            --sort=name \
            --mtime=@"${SOURCE_DATE_EPOCH}" \
            --owner=0 --group=0 --numeric-owner \
            -C _dist \
            "osqar-framework-${GITHUB_REF_NAME}" \
            | gzip -n > "${out}"

          sha256sum "${out}" > "${out}.sha256"

      - name: Create bundle archive (zip)
        run: |
          set -euo pipefail
          out="osqar_framework_bundle_${GITHUB_REF_NAME}.zip"
          rm -f "${out}" "${out}.sha256"
          (cd _dist && zip -r -q "../${out}" "osqar-framework-${GITHUB_REF_NAME}")
          sha256sum "${out}" > "${out}.sha256"

      - name: Upload framework bundle artifacts
        uses: actions/upload-artifact@v4
        with:
          name: osqar-framework-bundle
          path: |
            osqar_framework_bundle_${{ github.ref_name }}.tar.gz
            osqar_framework_bundle_${{ github.ref_name }}.tar.gz.sha256
            osqar_framework_bundle_${{ github.ref_name }}.zip
            osqar_framework_bundle_${{ github.ref_name }}.zip.sha256

  bazel-example-shipment:
    name: Example shipment (reproducible, Bazel) [${{ matrix.example }}]
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        example: [c_hello_world, cpp_hello_world, rust_hello_world]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install system build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            ca-certificates \
            build-essential \
            default-jre-headless \
            graphviz \
            plantuml

      - name: Set up Bazelisk
        uses: bazelbuild/setup-bazelisk@v3
        with:
          bazelisk-version: '1.20.0'

      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry

      - name: Configure Poetry
        run: |
          poetry config virtualenvs.create true
          poetry config virtualenvs.in-project true

      - name: Install dependencies
        run: poetry install --with evidence

      - name: Build reproducible Bazel shipment (${{ matrix.example }})
        run: |
          set -euo pipefail
          export SOURCE_DATE_EPOCH="$(git log -1 --format=%ct)"

          ex_dir="examples/${{ matrix.example }}"
          ship_root="_ci_shipments"
          ship_dir="${ship_root}/${{ matrix.example }}"
          out="osqar_${{ matrix.example }}_shipment.tar.gz"

          rm -rf "${ship_root}"
          mkdir -p "${ship_dir}/implementation" "${ship_dir}/tests" "${ship_dir}/reports"

          echo "== Building ${ex_dir} (Bazel, reproducible)"
          pushd "${ex_dir}" >/dev/null
          chmod +x ./bazel-build-and-test.sh

          OSQAR_REPRODUCIBLE=1 ./bazel-build-and-test.sh

          rm -f coverage_report.txt coverage.xml
          case "${{ matrix.example }}" in
            c_hello_world)
              rm -rf _coverage_build
              mkdir -p _coverage_build
              cc --coverage -O0 -g -Iinclude -c src/tsim.c -o _coverage_build/tsim.o
              cc --coverage -O0 -g -Iinclude -c tests/test_tsim.c -o _coverage_build/test_tsim.o
              cc --coverage -o _coverage_build/junit_tests _coverage_build/tsim.o _coverage_build/test_tsim.o
              ./_coverage_build/junit_tests test_results.xml
              poetry run gcovr -r . --object-directory _coverage_build --exclude 'tests/.*' --print-summary > coverage_report.txt 2>&1 || true
              poetry run gcovr -r . --object-directory _coverage_build --exclude 'tests/.*' --xml-pretty -o coverage.xml >/dev/null 2>&1 || true
              ;;
            cpp_hello_world)
              rm -rf _coverage_build
              mkdir -p _coverage_build
              c++ --coverage -O0 -g -Iinclude -c src/tsim.cpp -o _coverage_build/tsim.o
              c++ --coverage -O0 -g -Iinclude -c tests/test_tsim.cpp -o _coverage_build/test_tsim.o
              c++ --coverage -o _coverage_build/junit_tests _coverage_build/tsim.o _coverage_build/test_tsim.o
              ./_coverage_build/junit_tests test_results.xml
              poetry run gcovr -r . --object-directory _coverage_build --exclude 'tests/.*' --print-summary > coverage_report.txt 2>&1 || true
              poetry run gcovr -r . --object-directory _coverage_build --exclude 'tests/.*' --xml-pretty -o coverage.xml >/dev/null 2>&1 || true
              ;;
            rust_hello_world)
              if ! command -v cargo >/dev/null 2>&1; then
                curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --profile minimal --default-toolchain stable
                source "$HOME/.cargo/env"
              else
                source "$HOME/.cargo/env" 2>/dev/null || true
              fi

              rustup component add llvm-tools-preview >/dev/null 2>&1 || true
              cargo install cargo-llvm-cov --locked >/dev/null 2>&1 || true

              cargo llvm-cov run --locked --release --bin junit_tests -- test_results.xml >/dev/null 2>&1 || true
              cargo llvm-cov report --locked --release --summary-only > coverage_report.txt 2>&1 || true
              cargo llvm-cov report --locked --release --cobertura --output-path coverage.xml >/dev/null 2>&1 || true
              ;;
          esac

          if [ ! -f coverage_report.txt ]; then
            echo "Coverage report not generated." > coverage_report.txt
          fi

          rm -rf _build/html
          poetry run sphinx-build -b html . _build/html

          cp -f test_results.xml _build/html/test_results.xml
          cp -f coverage_report.txt _build/html/coverage_report.txt
          if [ -f coverage.xml ]; then
            cp -f coverage.xml _build/html/coverage.xml
          fi
          popd >/dev/null

          cp -a "${ex_dir}/_build/html/." "${ship_dir}/"

          if [ -d "${ex_dir}/src" ]; then
            mkdir -p "${ship_dir}/implementation/src"
            cp -a "${ex_dir}/src/." "${ship_dir}/implementation/src/"
          fi
          if [ -d "${ex_dir}/include" ]; then
            mkdir -p "${ship_dir}/implementation/include"
            cp -a "${ex_dir}/include/." "${ship_dir}/implementation/include/"
          fi
          if [ -d "${ex_dir}/tests" ]; then
            mkdir -p "${ship_dir}/tests"
            cp -a "${ex_dir}/tests/." "${ship_dir}/tests/"
          fi

          for f in CMakeLists.txt Cargo.toml Cargo.lock BUILD.bazel MODULE.bazel .bazelrc build-and-test.sh bazel-build-and-test.sh; do
            if [ -f "${ex_dir}/${f}" ]; then
              cp -a "${ex_dir}/${f}" "${ship_dir}/implementation/"
            fi
          done

          for f in test_results.xml coverage_report.txt coverage.xml complexity_report.txt; do
            if [ -f "${ex_dir}/${f}" ]; then
              cp -a "${ex_dir}/${f}" "${ship_dir}/reports/"
            fi
          done

          poetry run python tools/traceability_check.py \
            "${ship_dir}/needs.json" \
            --json-report "${ship_dir}/reports/traceability_report.json"

          poetry run python tools/generate_checksums.py --root "${ship_dir}" --output "${ship_dir}/SHA256SUMS"
          poetry run python tools/generate_checksums.py --root "${ship_dir}" --verify "${ship_dir}/SHA256SUMS"

          rm -f "${out}" "${out}.sha256"
          tar -c \
            --sort=name \
            --mtime=@"${SOURCE_DATE_EPOCH}" \
            --owner=0 --group=0 --numeric-owner \
            -C "${ship_root}" \
            "${{ matrix.example }}" \
            | gzip -n > "${out}"
          sha256sum "${out}" > "${out}.sha256"

      - name: Upload shipment archive (${{ matrix.example }})
        uses: actions/upload-artifact@v4
        with:
          name: osqar-example-shipment-${{ matrix.example }}
          path: |
            osqar_${{ matrix.example }}_shipment.tar.gz
            osqar_${{ matrix.example }}_shipment.tar.gz.sha256

  bazel-example-shipments:
    name: Example shipments (combined)
    runs-on: ubuntu-24.04
    needs: bazel-example-shipment
    steps:
      - uses: actions/checkout@v4

      - name: Download per-example shipments
        uses: actions/download-artifact@v4
        with:
          pattern: osqar-example-shipment-*
          path: _ci_per_example
          merge-multiple: true

      - name: Create combined deterministic archive
        run: |
          set -euo pipefail
          export SOURCE_DATE_EPOCH="$(git log -1 --format=%ct)"

          rm -rf _ci_shipments
          mkdir -p _ci_shipments

          for a in _ci_per_example/osqar_*_shipment.tar.gz; do
            tar -xzf "${a}" -C _ci_shipments
          done

          rm -f osqar_example_shipments.tar.gz osqar_example_shipments.tar.gz.sha256
          tar -c \
            --sort=name \
            --mtime=@"${SOURCE_DATE_EPOCH}" \
            --owner=0 --group=0 --numeric-owner \
            -C _ci_shipments \
            c_hello_world cpp_hello_world rust_hello_world \
            | gzip -n > osqar_example_shipments.tar.gz

          sha256sum osqar_example_shipments.tar.gz > osqar_example_shipments.tar.gz.sha256

      - name: Upload example shipments artifacts
        uses: actions/upload-artifact@v4
        with:
          name: osqar-example-shipments
          path: |
            osqar_example_shipments.tar.gz
            osqar_example_shipments.tar.gz.sha256
            _ci_per_example/osqar_c_hello_world_shipment.tar.gz
            _ci_per_example/osqar_c_hello_world_shipment.tar.gz.sha256
            _ci_per_example/osqar_cpp_hello_world_shipment.tar.gz
            _ci_per_example/osqar_cpp_hello_world_shipment.tar.gz.sha256
            _ci_per_example/osqar_rust_hello_world_shipment.tar.gz
            _ci_per_example/osqar_rust_hello_world_shipment.tar.gz.sha256

  publish:
    name: Publish GitHub Release assets
    runs-on: ubuntu-latest
    needs:
      - framework-bundle
      - bazel-example-shipments
    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: List files to upload
        run: |
          set -euo pipefail
          ls -la dist

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            # Framework tooling first
            dist/osqar_framework_bundle_${{ github.ref_name }}.tar.gz
            dist/osqar_framework_bundle_${{ github.ref_name }}.tar.gz.sha256
            dist/osqar_framework_bundle_${{ github.ref_name }}.zip
            dist/osqar_framework_bundle_${{ github.ref_name }}.zip.sha256

            # Combined shipments next
            dist/osqar_example_shipments.tar.gz
            dist/osqar_example_shipments.tar.gz.sha256

            # Per-example shipments last
            dist/osqar_c_hello_world_shipment.tar.gz
            dist/osqar_c_hello_world_shipment.tar.gz.sha256
            dist/osqar_cpp_hello_world_shipment.tar.gz
            dist/osqar_cpp_hello_world_shipment.tar.gz.sha256
            dist/osqar_rust_hello_world_shipment.tar.gz
            dist/osqar_rust_hello_world_shipment.tar.gz.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
